
/*
A simple "hello world" example.
Set the screen background color and palette colors.
Then write a message to the nametable.
Finally, turn on the PPU to display video.
*/

#include "neslib.h"
#include "stdlib.h"

//Function prototypes
void setLevel(int level);
void setScore(long score);

//Screen
const unsigned char Tetris_Screen_RLE[793]={
0x01,0x9f,0x8e,0x8f,0x01,0x02,0x8e,0x01,0x02,0x8f,0x8f,0x8e,0x8f,0x8e,0x8f,0x01,
0x02,0x8e,0x8e,0x8f,0x8f,0x8e,0x8f,0x8e,0x8f,0x01,0x02,0x8e,0x8e,0x8f,0x8e,0x8f,
0x8e,0x8f,0x01,0x02,0x8e,0x8f,0x9e,0x9e,0x8f,0x8f,0x9e,0x9e,0x9f,0x8e,0x8f,0x01,
0x02,0x9e,0x8f,0x8f,0x9e,0x9e,0x9f,0x8e,0x8f,0x01,0x02,0x9e,0x8f,0x9e,0x8f,0x9e,
0x9e,0x8f,0x8e,0x8f,0x8e,0x9e,0x9e,0x8e,0xc0,0xc1,0x01,0x09,0xc2,0xc0,0xc1,0x01,
0x05,0xc2,0x9e,0x8e,0x8f,0x9e,0x9e,0x9f,0x9e,0x9f,0x9e,0x01,0x03,0xd0,0x00,0x00,
0x54,0x45,0x54,0x52,0x49,0x53,0x00,0x00,0xd2,0xd0,0x00,0x01,0x05,0xd2,0x8e,0x9e,
0x9f,0x8e,0x9e,0x8e,0x8f,0x8f,0x9e,0x8e,0x8f,0x9e,0xe0,0xe1,0x01,0x09,0xe2,0xd0,
0x82,0x00,0x01,0x04,0xd2,0x9e,0x8e,0x8f,0x9e,0x8f,0x8e,0x8f,0x9e,0x01,0x02,0x9f,
0x9e,0xa5,0xa6,0x01,0x09,0xa7,0xd0,0x53,0x43,0x4f,0x52,0x45,0x3a,0xd2,0x9e,0x8f,
0x9e,0x8f,0x9e,0x9e,0x8e,0x8f,0x8e,0x8e,0x8f,0x8f,0xb5,0x00,0x01,0x09,0xb7,0xd0,
0x30,0x01,0x05,0xd2,0x8e,0x01,0x02,0x8f,0x8f,0x9e,0x9e,0x9f,0x9e,0x8f,0x8f,0x9e,
0xb5,0x00,0x01,0x09,0xb7,0xd0,0x00,0x01,0x05,0xd2,0x9e,0x9e,0xee,0x8e,0x9e,0x8e,
0x8f,0x8e,0x8f,0x8f,0x8e,0x8f,0xb5,0x00,0x01,0x09,0xb7,0xd0,0x00,0x01,0x05,0xd2,
0x9e,0x01,0x03,0x8f,0x8e,0x9e,0x8f,0x8e,0x9e,0x9e,0x9f,0xb5,0x00,0x01,0x09,0xb7,
0xe0,0xe1,0x01,0x05,0xe2,0x9e,0x8e,0xcc,0x8f,0x9e,0x9e,0x8f,0x8e,0xcc,0x8e,0x8f,
0x8e,0xb5,0x00,0x01,0x09,0xb7,0xed,0xee,0x01,0x02,0xed,0xee,0xef,0x8e,0x8f,0x8e,
0x8f,0x01,0x02,0x9e,0x8e,0x9e,0x8e,0x9e,0x9f,0x9e,0xb5,0x00,0x01,0x09,0xb7,0xa5,
0xa6,0x01,0x03,0xa7,0xff,0x9e,0x9f,0x8e,0x8f,0x8f,0x8e,0x8e,0xcc,0x8e,0x9e,0x8f,
0x8f,0x9e,0xb5,0x00,0x01,0x09,0xb7,0xb5,0x4e,0x45,0x58,0x54,0xb7,0x8e,0x8e,0x8f,
0x01,0x02,0x9e,0x01,0x02,0x8e,0x9e,0x8f,0x8e,0x8f,0x9e,0xb5,0x00,0x01,0x09,0xb7,
0xb5,0x00,0x01,0x03,0xb7,0x9e,0x8f,0x8f,0x8e,0x8f,0x8e,0xcc,0x8e,0xcc,0x8f,0x9e,
0x9e,0x9f,0x8e,0xb5,0x00,0x01,0x09,0xb7,0xb5,0x00,0x01,0x03,0xb7,0x8e,0x8f,0x8e,
0x8f,0x9e,0x8f,0x8e,0x01,0x02,0x8f,0x8f,0x8e,0x8f,0xcc,0xb5,0x00,0x01,0x09,0xb7,
0xb5,0x00,0x01,0x03,0xb7,0x8e,0x9e,0x9e,0x9f,0x8e,0x8e,0xcc,0x9e,0x8e,0x9e,0x8e,
0x8f,0x8e,0x8f,0xb5,0x00,0x01,0x09,0xb7,0xb5,0x00,0x01,0x03,0xb7,0x9e,0x9e,0x8e,
0x8f,0xcc,0x9e,0x8e,0x9e,0x9e,0x8e,0x8f,0x9e,0x8f,0x9e,0xb5,0x00,0x01,0x09,0xb7,
0xc5,0xc6,0x01,0x03,0xc7,0x9e,0x8f,0x8e,0x8e,0x8f,0x8e,0xcc,0x9e,0x01,0x02,0x9f,
0x8e,0x8f,0x9e,0xb5,0x00,0x01,0x09,0xb7,0xc0,0xc1,0x01,0x04,0xc2,0x8e,0xcc,0x9e,
0x9f,0x9e,0x8e,0x8e,0x9e,0x8e,0x8e,0xcc,0x8e,0x8f,0xb5,0x00,0x01,0x09,0xb7,0xd0,
0x4c,0x45,0x56,0x45,0x4c,0xd2,0x8e,0x9e,0x8e,0x8f,0x8f,0x9e,0x9e,0x8e,0x9e,0x8f,
0x8e,0x9e,0x9f,0xb5,0x00,0x01,0x09,0xb7,0xd0,0x00,0x01,0x02,0x30,0x00,0xd2,0x9e,
0x8f,0x8f,0x9e,0x8e,0xcc,0x9e,0x9e,0x8f,0x9e,0x9e,0x8f,0x8f,0xb5,0x00,0x01,0x09,
0xb7,0xe0,0xe1,0x01,0x04,0xe2,0x8e,0x8e,0x8f,0x8e,0x8f,0x8f,0x9e,0x9e,0x8e,0x8e,
0x8f,0x8e,0x8f,0xb5,0x00,0x01,0x09,0xb7,0x8e,0x8e,0x8f,0x8f,0x8e,0x8f,0x8e,0x9e,
0x8f,0x9e,0x8f,0x8e,0x9e,0x8e,0x8e,0xcc,0x9e,0x8e,0x8f,0x9e,0xb5,0x00,0x01,0x09,
0xb7,0x9e,0x8e,0x8f,0x9e,0x9e,0x9f,0x9e,0x9e,0x8e,0x8f,0x8e,0xcc,0x8f,0x9e,0x9e,
0x8e,0x9e,0x9e,0x8e,0x9e,0xb5,0x00,0x01,0x09,0xb7,0x9e,0x9e,0x8e,0x8e,0x8f,0x8f,
0x9e,0x8f,0x9e,0x9f,0x8e,0x01,0x02,0x9e,0x8f,0x9e,0x8e,0x9e,0x9e,0x8f,0xb5,0x00,
0x01,0x09,0xb7,0x9e,0x01,0x02,0x8f,0x9e,0x8e,0x8e,0x8f,0x8f,0x8e,0xcc,0x9e,0x9e,
0x8e,0x8f,0x9e,0x9e,0x8f,0x8e,0x9e,0xc5,0xc6,0x01,0x09,0xc7,0x8e,0x8f,0x9e,0x8e,
0x8e,0xcc,0x8e,0x8f,0x9e,0x9e,0x8e,0xcc,0x9e,0x9e,0x8e,0x9e,0x9e,0x8e,0x9e,0x8f,
0x8f,0x8e,0x8f,0x01,0x02,0x8e,0x8f,0x8f,0x8e,0x8f,0x8e,0x8f,0x8e,0x9e,0x8e,0xcc,
0x8f,0x9e,0x9e,0x9f,0x8e,0x8f,0x8e,0x8f,0x9e,0x01,0x02,0x8e,0x8f,0x9e,0x8f,0x8f,
0x8e,0x8f,0x8e,0x8f,0x8f,0x8e,0x8f,0x9e,0x9e,0x9f,0x9e,0x8e,0xcc,0x9e,0x8e,0x8e,
0x8f,0x8e,0x8f,0x8f,0x9e,0x9f,0x9e,0x8e,0x8f,0x8f,0xcc,0x9e,0x9f,0x8e,0x8f,0x01,
0x02,0x9e,0x8f,0x9e,0x8e,0xcc,0x8e,0x8f,0x01,0x02,0x9e,0x9e,0x8e,0x8f,0xcc,0x9e,
0x9f,0x9e,0x8e,0x8f,0x01,0x02,0x9e,0x9e,0x9f,0xff,0x01,0x09,0x3f,0x0f,0xff,0x01,
0x06,0x00,0xff,0x01,0x05,0x3f,0x33,0xff,0x01,0x05,0xf3,0xf3,0xff,0x01,0x05,0x3f,
0xff,0x01,0x0c,0x0f,0x01,0x06,0x0f,0x01,0x00
};

const char tetriminos[][4][2] = {
  {{-1, 0}, {0, 0}, {1, 0}, {0, -1}},
  {{0, -1}, {0, 0}, {1, 0}, {0, 1}},
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
  
  {{}, {}, {}, {}},
  {{}, {}, {}, {}},
};

// link the pattern table into CHR ROM
//#link "chr_generic.s"

/*{pal:"nes",layout:"nes"}*/
const unsigned char BG_PAL[16]={ 0x0F,0x00,0x10,0x30,0x0F,0x01,0x21,0x3C,0x0F,0x06,0x16,0x26,0x0F,0x2C,0x00,0x30 };


// main function, run after console reset
void main(void) {
  // set up palette colors
  pal_bg(BG_PAL);
  
  //Draw Initial Screen
  vram_adr(0x2000);		
  vram_unrle(Tetris_Screen_RLE);
  
  setLevel(30);
  setScore(23425);
  
  // enable PPU rendering (turn on screen)
  ppu_on_all();

  // infinite loop
  while (1) ;
}

//Note level can't go above 99. Also, if you can even get past level 30 you're a god
void setLevel(int level) {
  char lstring[3];
  int row = 23;
  int len = 1;
  level /= 10;
  
  if(level > 9) {
    row = 22;
    len = 2;
  }
  
  itoa(level, lstring, 10);
  vram_adr(NTADR_A(row, 20));
  vram_write(lstring, len);
}

void setScore(long score) {
  char scoreString[7];
  int row = 25;
  int len = 1;
  
  if(score >= 100000) {
    row = 20;
    len = 6;
  }
  else if(score >= 10000) {
    row = 21;
    len = 5;
  }
  else  if(score >= 1000) {
    row = 22;
    len = 4;
  }
  else if(score >= 100) {
    row = 23;
    len = 3;
  }
  else if(score >= 10) {
    row = 24;
    len = 2;
  }
  
  ltoa(score, scoreString, 10);
  vram_adr(NTADR_A(row, 6));
  vram_write(scoreString, len);
}